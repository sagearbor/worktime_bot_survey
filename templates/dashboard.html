<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCRI Activity Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { padding: 2rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">DCRI Activity Dashboard</h1>
        <div class="box mb-4">
            <div class="field">
                <label class="label" for="group-filter">Group</label>
                <div class="control">
                    <div class="select">
                        <select id="group-filter">
                            <option value="">All groups</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="field">
                <label class="label" for="start-date">Start Date</label>
                <div class="control">
                    <input id="start-date" type="date" class="input">
                </div>
            </div>
            <div class="field">
                <label class="label" for="end-date">End Date</label>
                <div class="control">
                    <input id="end-date" type="date" class="input">
                </div>
            </div>
            <div class="field">
                <div class="control">
                    <button id="apply-filters" class="button is-link">Apply Filters</button>
                </div>
            </div>
        </div>
        <div id="dashboard-content">
            <p id="loading-message">Loading results...</p>
        </div>
    </div>
    <script>
        // Fetch aggregated results with optional filters and render charts
        document.addEventListener("DOMContentLoaded", async () => {
            const container = document.getElementById("dashboard-content");
            const groupSelect = document.getElementById("group-filter");
            const startDateInput = document.getElementById("start-date");
            const endDateInput = document.getElementById("end-date");
            const applyBtn = document.getElementById("apply-filters");

            async function loadConfig() {
                try {
                    const res = await fetch("/api/config");
                    if (!res.ok) throw new Error("Failed to load configuration");
                    const cfg = await res.json();
                    cfg.groups.forEach((g) => {
                        const opt = document.createElement("option");
                        opt.value = g.id;
                        opt.textContent = g.displayName;
                        groupSelect.appendChild(opt);
                    });
                } catch (err) {
                    console.error("Error loading config:", err);
                }
            }

            function renderCharts(data) {
                const groupTotals = {};
                const activityTotals = {};
                data.forEach((row) => {
                    groupTotals[row.group_id] = (groupTotals[row.group_id] || 0) + row.count;
                    activityTotals[row.activity] = (activityTotals[row.activity] || 0) + row.count;
                });

                container.innerHTML = "";
                const groupCanvas = document.createElement("canvas");
                container.appendChild(groupCanvas);
                new Chart(groupCanvas.getContext("2d"), {
                    type: "bar",
                    data: {
                        labels: Object.keys(groupTotals),
                        datasets: [
                            {
                                label: "Time by Group",
                                data: Object.values(groupTotals),
                                backgroundColor: "rgba(54, 162, 235, 0.7)",
                            },
                        ],
                    },
                    options: { responsive: true, plugins: { legend: { display: false } } },
                });

                const activityCanvas = document.createElement("canvas");
                container.appendChild(activityCanvas);
                new Chart(activityCanvas.getContext("2d"), {
                    type: "bar",
                    data: {
                        labels: Object.keys(activityTotals),
                        datasets: [
                            {
                                label: "Time by Activity",
                                data: Object.values(activityTotals),
                                backgroundColor: "rgba(75, 192, 192, 0.7)",
                            },
                        ],
                    },
                    options: { responsive: true, plugins: { legend: { display: false } } },
                });
            }

            async function fetchResults() {
                const params = new URLSearchParams();
                if (groupSelect.value) params.set("group_id", groupSelect.value);
                if (startDateInput.value) params.set("start_date", startDateInput.value);
                if (endDateInput.value) params.set("end_date", endDateInput.value);
                const res = await fetch(`/api/results?${params.toString()}`);
                if (!res.ok) throw new Error("Failed to load results");
                return res.json();
            }

            async function updateDashboard() {
                container.innerHTML = '<p id="loading-message">Loading results...</p>';
                try {
                    const data = await fetchResults();
                    renderCharts(data);
                } catch (err) {
                    console.error("Error fetching results:", err);
                    container.textContent = "Error loading results.";
                }
            }

            await loadConfig();
            await updateDashboard();

            applyBtn.addEventListener("click", (e) => {
                e.preventDefault();
                updateDashboard();
            });
        });
    </script>
</body>
</html>
